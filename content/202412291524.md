---
title: iptables详解
description: iptables 是 Linux 系统中一个强大的防火墙工具，它实际上是一个命令行实用程序，用于配置 Linux 内核防火墙 netfilter
cover:
keywords: [iptables, netfilter, network, linux]
category: tutorial
updateAt: 2024-12-29T15:24:54+08:00
draft: false
---

## 一、iptables 是什么？

`iptables` 是 `Linux` 系统中一个强大的防火墙工具，它实际上是一个命令行实用程序，用于配置 Linux 内核防火墙 `netfilter`。而 `netfilter` 是内核中的一个框架，负责网络数据包的过滤、修改和转发。如果把 `netfilter` 看作是防火墙的“骨架”，而 `iptables` 则是用来控制这个骨架的“工具”。

简单来说，`iptables` 允许你定义规则，决定如何处理进出你计算机或网络的网络流量。这些规则可以基于各种标准，例如源 IP 地址、目标 IP 地址、端口号和协议。

## 二、概念解析

### 1、iptables 的表和链

iptables 使用表 (tables) 和链 (chains) 来组织规则。

- 表 (tables)：是规则的集合，每个表用于处理特定类型的网络流量。常用的表有：
  - `filter` 表：用于过滤数据包，这是最常用的表。
  - `nat` 表：用于网络地址转换。
  - `mangle` 表：用于修改数据包的头部信息。
  - `raw` 表：用于配置数据包的连接追踪。
- 链 (chains)：是表中的规则列表。常用的链有：
  - `INPUT` 链：处理进入计算机的数据包。
  - `OUTPUT` 链：处理从计算机发出的数据包。
  - `FORWARD` 链：处理通过计算机转发的数据包。

### 2、iptables 的规则

规则是 iptables 的核心。每个规则指定一个匹配条件和一个目标 (target)。

- 匹配条件：定义规则应用于哪些数据包。例如，你可以指定源 IP 地址、目标端口或协议。
- 目标 (target)：指定匹配规则的数据包应采取的操作。常用的目标有：
- ACCEPT：允许数据包通过。
- DROP：丢弃数据包。
- REJECT：拒绝数据包，并向发送方发送一个错误消息。

### 3、数据包在 iptables 中的流向

一个网络数据包在进入或离开你的 Linux 系统时，会按照特定的顺序经过不同的表和链。这个顺序非常重要，因为它决定了规则的应用顺序，也决定了不同表之间的规则如何“相互作用”。

以下是数据包在 `iptables` 中的典型流向：

- 进入本机 (INPUT 链)：
  - `raw` 表的 `PREROUTING` 链
  - `mangle` 表的 `PREROUTING` 链
  - `nat` 表的 `PREROUTING` 链 (如果数据包的目标地址是本机)
  - `filter` 表的 `INPUT` 链
- 从本机发出 (OUTPUT 链)：
  - `raw` 表的 `OUTPUT` 链
  - `mangle` 表的 `OUTPUT` 链
  - `nat` 表的 `POSTROUTING` 链 (如果需要进行源地址转换)
  - `filter` 表的 `OUTPUT` 链
- 通过本机转发 (FORWARD 链)：
  - `raw` 表的 `PREROUTING` 链
  - `mangle` 表的 `PREROUTING` 链
  - `filter` 表的 `FORWARD` 链
  - `mangle` 表的 `POSTROUTING` 链
  - `nat` 表的 `POSTROUTING` 链

每个表都有其特定的功能，因此它们在数据包处理的不同阶段起作用：

- `raw` 表： 主要用于配置连接跟踪。它在所有其他表之前处理数据包，因此可以用来绕过连接跟踪或进行特殊的处理。在这个表中的规则通常不会与其他表的规则“冲突”，因为它们处理的是连接跟踪相关的设置。
- `mangle` 表： 用于修改数据包的头部信息。例如，可以修改 TTL 值、TOS 字段等。在这个表中的规则可能会影响其他表的规则，例如修改了 TOS 字段可能会影响 filter 表中基于 TOS 的规则匹配。
- `nat` 表： 用于网络地址转换 (NAT)。它可以修改数据包的源地址或目标地址。这个表中的规则会显著影响 filter 表的规则，因为地址的改变会导致 filter 表的规则匹配发生变化。
- `filter` 表： 用于过滤数据包。它根据规则决定是否允许数据包通过。这是最常用的表，其规则的顺序和逻辑非常重要。

## 三、使用方法

> 可以用 `-t` 选项指定表名，如果不指定默认为 `filter` 表

### 1、基本操作命令

- **`iptables -L -v --line-number`**：列出 `filter` 表的规则，`-v` 参数显示更详细的信息，例如数据包计数器和字节计数器， `--line-number` 显示行号，方便其他命令指定规则。
- **`iptables -F`**：清空指定表的所有规则。例如，`iptables -F filter` 清空 filter 表的所有规则。不指定表名则清空所有表的规则。
- **`iptables -X`**：删除用户自定义的链。
- **`iptables -Z`**：将所有链的计数器清零。
- **`iptables -P <链名> <策略>`**：设置指定链的默认策略。策略可以是 `ACCEPT`（接受）、`DROP`（丢弃）或 `REJECT`（拒绝并发送错误信息）。例如，`iptables -P INPUT DROP` 将 INPUT 链的默认策略设置为丢弃所有进入的数据包。
- **`iptables -E <旧链名> <新链名>`**：重命名用户自定义的链。

### 2、规则管理命令

- **`iptables -A <链名> <规则>`**：在指定链的末尾添加一条规则。
- **`iptables -I <链名> [规则编号] <规则>`**：在指定链的开头或指定编号处插入一条规则。例如，`iptables -I INPUT 2 <规则>` 将规则插入到 INPUT 链的第二条。
- **`iptables -D <链名> <规则编号>`** 或 **`iptables -D <链名> <规则>`**：删除指定链中的一条规则。可以通过规则编号或完整规则来删除。
- **`iptables -R <链名> <规则编号> <新规则>`**：替换指定链中指定编号的规则。

### 3、规则匹配选项

以下是一些常用的规则匹配选项：

- **`-p <协议>`**：指定协议，例如 `tcp`、`udp`、`icmp`。
- **`-s <源地址>`**：指定源 IP 地址或网络地址。例如，`192.168.1.100` 或 `192.168.1.0/24`。可以使用 `!` 取反，例如 `! 192.168.1.0/24` 表示除了 192.168.1.0/24 网络之外的所有地址。
- **`-d <目标地址>`**：指定目标 IP 地址或网络地址，用法同 `-s`。
- **`--sport <源端口>`**：指定源端口号或端口范围。例如，`22` 或 `1024:65535`。
- **`--dport <目标端口>`**：指定目标端口号或端口范围，用法同 `--sport`。
- **`-i <网络接口>`**：指定数据包进入的网络接口。例如，`eth0`。
- **`-o <网络接口>`**：指定数据包发出的网络接口。例如，`eth0`。
- **`-m <模块名>`**：加载额外的匹配模块，例如 `state`、`conntrack`、`multiport` 等。

### 4、目标（Target）选项

以下是一些常用的目标选项：

- **`-j ACCEPT`**：接受数据包。
- **`-j DROP`**：丢弃数据包。
- **`-j REJECT`**：拒绝数据包，并向发送方发送一个错误信息。可以使用 `--reject-with <类型>` 指定拒绝类型，例如 `icmp-port-unreachable`。
- **`-j LOG`**：记录数据包信息到日志。可以使用 `--log-prefix <前缀>` 指定日志前缀。
- **`-j MASQUERADE`**：用于 NAT，将私有网络地址伪装成公网 IP 地址。
- **`-j SNAT --to-source <IP地址>`**：源地址转换。
- **`-j DNAT --to-destination <IP地址>`**：目标地址转换。

### 5、常用组合示例

- **允许 SSH 流量：** `iptables -A INPUT -p tcp --dport 22 -j ACCEPT`
- **阻止来自特定 IP 的流量：** `iptables -A INPUT -s 192.168.1.100 -j DROP`
- **允许来自本地网络的流量：** `iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT`
- **允许 ping：** `iptables -A INPUT -p icmp -j ACCEPT`
- **记录被丢弃的数据包：** `iptables -A INPUT -j LOG --log-prefix "Dropped packets: "`

### 6、保存和恢复规则

- **`iptables-save`**：保存当前规则到文件。通常保存到 `/etc/sysconfig/iptables`（CentOS/RHEL）或 `/etc/iptables/rules.v4`（Debian/Ubuntu）。
- **`iptables-restore <文件名>`**：从文件恢复规则。

### 7、**重要提示：**

- 规则的顺序非常重要，iptables 会按顺序检查规则。
- 在修改 iptables 规则之前，最好先备份当前的规则。
- 测试新的规则时要小心，以免意外阻止了重要的网络连接。
- `iptables` 命令是即时生效的，但重启后会失效。需要使用 `iptables-save` 和 `iptables-restore` 命令来持久化规则。

## 五、外部链接

- [官方文档](https://www.netfilter.org/projects/iptables/index.html)
